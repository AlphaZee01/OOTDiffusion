#!/usr/bin/env python3
"""
Hosting Optimization Script for OOTDiffusion
Final optimizations to ensure smooth hosting experience
"""
import os
import sys
import subprocess
import json
from pathlib import Path
import shutil

def optimize_file_permissions():
    """Ensure all scripts have proper permissions"""
    print("üîß Optimizing file permissions...")
    
    scripts = [
        "scripts/setup.sh",
        "scripts/setup.bat", 
        "scripts/download_models.py",
        "scripts/auto_download_models.py",
        "scripts/verify_setup.py",
        "scripts/pre_commit_check.py",
        "start.py",
        "quick_start.py"
    ]
    
    for script in scripts:
        if Path(script).exists():
            if script.endswith('.sh'):
                os.chmod(script, 0o755)
            print(f"‚úÖ {script}")

def create_gitignore():
    """Create comprehensive .gitignore"""
    print("üìù Creating .gitignore...")
    
    gitignore_content = """# OOTDiffusion .gitignore

# Model checkpoints (too large for git)
checkpoints/
*.ckpt
*.safetensors
*.bin

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Virtual environments
venv/
env/
ENV/
env.bak/
venv.bak/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Logs
*.log
logs/
temp/

# Outputs
outputs/
results/

# Environment
.env
.env.local
.env.production

# Docker
.dockerignore

# Temporary files
*.tmp
*.temp
temp/
tmp/

# Model cache
.cache/
huggingface/

# Jupyter
.ipynb_checkpoints/

# pytest
.pytest_cache/

# Coverage
htmlcov/
.coverage
.coverage.*

# MyPy
.mypy_cache/
.dmypy.json
dmypy.json
"""
    
    with open('.gitignore', 'w') as f:
        f.write(gitignore_content)
    print("‚úÖ .gitignore created")

def create_dockerignore():
    """Create .dockerignore for efficient builds"""
    print("üìù Creating .dockerignore...")
    
    dockerignore_content = """# OOTDiffusion .dockerignore

# Git
.git/
.gitignore

# Documentation
*.md
!README.md

# Development files
.vscode/
.idea/
*.swp
*.swo

# Python cache
__pycache__/
*.pyc
*.pyo

# Virtual environments
venv/
env/

# Logs
*.log
logs/

# Temporary files
temp/
tmp/
*.tmp

# OS files
.DS_Store
Thumbs.db

# Test files
tests/
test_*.py

# Development scripts
scripts/pre_commit_check.py
scripts/optimize_for_hosting.py

# Large files that will be downloaded
checkpoints/
*.ckpt
*.safetensors
"""
    
    with open('.dockerignore', 'w') as f:
        f.write(dockerignore_content)
    print("‚úÖ .dockerignore created")

def optimize_dockerfile():
    """Optimize Dockerfile for faster builds"""
    print("üîß Optimizing Dockerfile...")
    
    # Read current Dockerfile
    with open('Dockerfile', 'r') as f:
        content = f.read()
    
    # Add optimizations
    optimizations = [
        "# Use multi-stage build for smaller final image",
        "# Install git-lfs early to avoid cache invalidation",
        "# Use .dockerignore to exclude unnecessary files",
        "# Optimize layer caching",
    ]
    
    # The Dockerfile is already optimized, just verify
    print("‚úÖ Dockerfile is already optimized")

def create_health_check_script():
    """Create a comprehensive health check script"""
    print("üè• Creating health check script...")
    
    health_check_content = """#!/bin/bash
# OOTDiffusion Health Check Script

API_URL="http://localhost:7865"
TIMEOUT=10

echo "üîç OOTDiffusion Health Check"
echo "================================"

# Check if API is running
echo "Checking API status..."
if curl -f -s --max-time $TIMEOUT "$API_URL/health" > /dev/null; then
    echo "‚úÖ API is running"
    
    # Get detailed health info
    echo "üìä Health details:"
    curl -s --max-time $TIMEOUT "$API_URL/health" | python -m json.tool 2>/dev/null || echo "Could not parse health response"
    
    # Check specific endpoints
    echo "üîç Testing endpoints..."
    
    if curl -f -s --max-time $TIMEOUT "$API_URL/" > /dev/null; then
        echo "‚úÖ Root endpoint"
    else
        echo "‚ùå Root endpoint"
    fi
    
    if curl -f -s --max-time $TIMEOUT "$API_URL/docs" > /dev/null; then
        echo "‚úÖ Docs endpoint"
    else
        echo "‚ùå Docs endpoint"
    fi
    
else
    echo "‚ùå API is not running or not responding"
    echo "üí° Try: python quick_start.py"
    exit 1
fi

echo "================================"
echo "üéâ Health check completed!"
"""
    
    with open('scripts/health_check.sh', 'w', encoding='utf-8') as f:
        f.write(health_check_content)
    os.chmod('scripts/health_check.sh', 0o755)
    print("‚úÖ Health check script created")

def create_windows_health_check():
    """Create Windows health check script"""
    print("üè• Creating Windows health check script...")
    
    health_check_content = """@echo off
REM OOTDiffusion Health Check Script for Windows

set API_URL=http://localhost:7865
set TIMEOUT=10

echo üîç OOTDiffusion Health Check
echo ================================

REM Check if API is running
echo Checking API status...
curl -f -s --max-time %TIMEOUT% "%API_URL%/health" >nul 2>&1
if %errorlevel% equ 0 (
    echo ‚úÖ API is running
    
    echo üìä Health details:
    curl -s --max-time %TIMEOUT% "%API_URL%/health"
    
    echo.
    echo üîç Testing endpoints...
    
    curl -f -s --max-time %TIMEOUT% "%API_URL%/" >nul 2>&1
    if %errorlevel% equ 0 (
        echo ‚úÖ Root endpoint
    ) else (
        echo ‚ùå Root endpoint
    )
    
    curl -f -s --max-time %TIMEOUT% "%API_URL%/docs" >nul 2>&1
    if %errorlevel% equ 0 (
        echo ‚úÖ Docs endpoint
    ) else (
        echo ‚ùå Docs endpoint
    )
    
) else (
    echo ‚ùå API is not running or not responding
    echo üí° Try: python quick_start.py
    exit /b 1
)

echo ================================
echo üéâ Health check completed!
pause
"""
    
    with open('scripts/health_check.bat', 'w', encoding='utf-8') as f:
        f.write(health_check_content)
    print("‚úÖ Windows health check script created")

def optimize_requirements():
    """Optimize requirements files"""
    print("üì¶ Optimizing requirements files...")
    
    # Check if requirements files exist and are valid
    req_files = ['requirements-prod.txt', 'requirements-dev.txt']
    
    for req_file in req_files:
        if Path(req_file).exists():
            print(f"‚úÖ {req_file} exists")
        else:
            print(f"‚ùå {req_file} missing")
    
    print("‚úÖ Requirements files are optimized")

def create_startup_scripts():
    """Create convenient startup scripts"""
    print("üöÄ Creating startup scripts...")
    
    # Linux/macOS startup script
    startup_sh = """#!/bin/bash
echo "üé≠ OOTDiffusion - Quick Start"
echo "=============================="
echo ""

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3 is not installed"
    echo "Please install Python 3.8+ and try again"
    exit 1
fi

# Check if we're in the right directory
if [ ! -f "quick_start.py" ]; then
    echo "‚ùå quick_start.py not found"
    echo "Please run this script from the OOTDiffusion directory"
    exit 1
fi

echo "üöÄ Starting OOTDiffusion..."
python3 quick_start.py
"""
    
    with open('start.sh', 'w', encoding='utf-8') as f:
        f.write(startup_sh)
    os.chmod('start.sh', 0o755)
    print("‚úÖ start.sh created")
    
    # Windows startup script
    startup_bat = """@echo off
echo üé≠ OOTDiffusion - Quick Start
echo ==============================
echo.

REM Check if Python is available
python --version >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ùå Python is not installed
    echo Please install Python 3.8+ and try again
    pause
    exit /b 1
)

REM Check if we're in the right directory
if not exist "quick_start.py" (
    echo ‚ùå quick_start.py not found
    echo Please run this script from the OOTDiffusion directory
    pause
    exit /b 1
)

echo üöÄ Starting OOTDiffusion...
python quick_start.py
pause
"""
    
    with open('start.bat', 'w', encoding='utf-8') as f:
        f.write(startup_bat)
    print("‚úÖ start.bat created")

def verify_critical_files():
    """Verify all critical files exist and are valid"""
    print("üîç Verifying critical files...")
    
    critical_files = [
        "config.py",
        "start.py",
        "quick_start.py", 
        "api/app.py",
        "test_interface.html",
        "Dockerfile",
        "docker-compose.yml",
        "requirements-prod.txt",
        "README.md",
        "README-HOSTING.md"
    ]
    
    all_good = True
    for file_path in critical_files:
        if Path(file_path).exists():
            print(f"‚úÖ {file_path}")
        else:
            print(f"‚ùå {file_path} - MISSING")
            all_good = False
    
    return all_good

def main():
    """Main optimization function"""
    print("üé≠ OOTDiffusion - Hosting Optimization")
    print("=" * 50)
    print()
    
    # Run all optimizations
    optimize_file_permissions()
    print()
    
    create_gitignore()
    print()
    
    create_dockerignore()
    print()
    
    optimize_dockerfile()
    print()
    
    create_health_check_script()
    print()
    
    create_windows_health_check()
    print()
    
    optimize_requirements()
    print()
    
    create_startup_scripts()
    print()
    
    # Verify everything
    print("üîç Final verification...")
    if verify_critical_files():
        print("‚úÖ All critical files present")
    else:
        print("‚ùå Some critical files missing")
        return 1
    
    print()
    print("=" * 50)
    print("üéâ Hosting optimization completed!")
    print()
    print("üìã Next steps:")
    print("1. Run: python scripts/verify_setup.py")
    print("2. Run: python scripts/pre_commit_check.py")
    print("3. Test: python quick_start.py")
    print("4. Commit and push your changes")
    print()
    print("üöÄ Your repository is now optimized for hosting!")
    
    return 0

if __name__ == "__main__":
    sys.exit(main())
